<html>

<head>
	<script type="text/javascript" src="external/ocanvas-2.8.1.js"></script>
	<script type="text/javascript" src="external/underscore.js"></script>

	<script type="text/javascript" src="world.js"></script>
	<script type="text/javascript" src="agent.js"></script>

<script type="text/javascript">


// 	Add unit test of world of step 1 and validation
// 	Add more than one unit tests and see canvas recreated
//  generate a configuration page
//		Grid size

function processInput() {
	var input = document.getElementById('input').value;
	document.getElementById('output').value = input;
}


oCanvas.domReady( function() {
	var canvas = oCanvas.create({ canvas: "#myCanvas", background: "#222" });

	var AGENT_SIZE = 1;
	var world = new World(canvas, 
		{
			AGENT_SIZE: 10
		} //
	);	


	var randStartConf = function(n,squareSize) {
		var ret = [];
		for (var i = 0; i < n; i++) {
			ret.push(new Agent(
							squareSize-Math.floor(Math.random()*squareSize*2),
							squareSize-Math.floor(Math.random()*squareSize*2)
							)
			);
		}
		return ret;
	}


var conf1 = [
		new Agent(0,0),
		new Agent(1,0),
		new Agent(0,1),
		new Agent(1,1)
];

	//world.addAgentsToWorld(randStartConf(100,10),canvas);
	world.addAgentsToWorld(conf1,canvas);

	// Set up a tick function that will move all satellites each frame

	var moveRandomly = function () {

		_.each(world.agents,function(agent) {
			if (agent!=null) {
					var xDiff = (Math.random()>.5) ,
						yDiff = 1- xDiff,
						sign = (Math.random()>.5) ?1:-1;

					world.moveAgent(xDiff*sign,yDiff*sign,agent);
				}
			}
		)
	};


	var gameOfLife = function () {

		var getNeigboursNo = function(agent) {
			var ret = 0,
				diffs = [[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
			for (var i = 0; i < diffs.length; i++) {
				ret += (world.getAgent(agent.view.x+diffs[i][0],agent.view.y+diffs[i][1])!=null);
			}
			return ret;
		}

		var tmpGrid = [];



		_.each(world.agents,function(agent) {
			if (agent!= null) {
				var n = getNeigboursNo(agent);
				//colourTmpGrid(tmpGrid,agent);
				if ((n<2) || (n>3)) {
					world.removeAgent(agent);
				}
			}
		});

		//wake awakeneing cells from the tmp grid
	};

	canvas.setLoop(moveRandomly).start();
	//canvas.setLoop(gameOfLife).start();

});

</script>
</head>


<body>

<textarea id = "input"></textarea>
<br/>
<input type="button" value="Process Input" onclick="processInput()"></input>
<br/>

<textarea id = "output"></textarea>

<br/><br/>

<canvas id="myCanvas"  width="500" height="500" >
</canvas>


</body>
</html>
