<html>

<head>
	<script type="text/javascript" src="ocanvas-2.8.1.js"></script>
	<script type="text/javascript" src="underscore.js"></script>

<script type="text/javascript">

//	GIT 
//	Break into classes
// 	unit tests of world
// 	generate a configuration page
//		Grid size

function processInput() {
	var input = document.getElementById('input').value;
	document.getElementById('output').value = input;
}




var AGENT_SIZE = 1;


world = {
	agents:{},
	grid:{
		columns:{},
		get:function(x,y) {
			var ret = null;
			var col = this.columns[x];
			if (col != null) {
				ret = col[y];
			}
			return ret;
		},

		put:function(x,y,agent) {
			var col = this.columns[x];
			if (col == null) {
				col = this.columns[x] = {};
			}
			col[y] = agent;

		}
	},
	getAgent:function(x,y) {
		return this.grid.get(x,y);
	},

	addAgentsToWorld:function(arr,canvas) {
		for (var i = 0; i < arr.length; i++) {
			var agent = arr[i];
			var x = canvas.width / 2 + agent.xStart*AGENT_SIZE,
				y = canvas.height / 2 + agent.yStart*AGENT_SIZE;
			if (this.getAgent(x,y)==null) {
				agent.view = canvas.display.rectangle({
					x:0, y:0,
					width: AGENT_SIZE,	height: AGENT_SIZE,
					fill: "#fff"
				}).add();
				this.placeAgent(x,y,agent);
				this.agents[agent.id] = agent;
			} else {
				console.log("Collision")
			}
		}
	},

	placeAgent:function(x,y,agent) {
			if (this.getAgent(x,y)==null) {
				this.grid.put(agent.view.x,agent.view.y,null);
				agent.view.x = x; agent.view.y = y;
				this.grid.put(agent.view.x,agent.view.y,agent);
			}
	},
	moveAgent:function(xD,yD,agent) {
		this.placeAgent(agent.view.x+xD,agent.view.y+yD,agent)
	},

	removeAgent: function(agent) {
		this.agents[agent.id] = null;
		this.grid.put(agent.view.x,agent.view.y,null);
	}
}


var AGENT_MAX_ID = 1;
function Agent(xStart,yStart) {
	this.id = AGENT_MAX_ID++;
	this.xStart = xStart ; this.yStart = yStart;
	console.log ("Agent: " + this.id);
}





oCanvas.domReady( function() {
	var canvas = oCanvas.create({ canvas: "#myCanvas", background: "#222" });

	var randStartConf = function(n,squareSize) {
		var ret = [];
		for (var i = 0; i < n; i++) {
			ret.push(new Agent(
							squareSize-Math.floor(Math.random()*squareSize*2),
							squareSize-Math.floor(Math.random()*squareSize*2)
							)
			);
		}
		return ret;
	}


var conf1 = [
		new Agent(0,0),
		new Agent(1,0),
		new Agent(0,1),
		new Agent(1,1)
];

	//world.addAgentsToWorld(randStartConf(100,10),canvas);
	world.addAgentsToWorld(conf1,canvas);

	// Set up a tick function that will move all satellites each frame

	var moveRandomly = function () {

		_.each(world.agents,function(agent) {
			if (agent!=null) {
					var xDiff = (Math.random()>.5) ,
						yDiff = 1- xDiff,
						sign = (Math.random()>.5) ?1:-1;

					world.moveAgent(xDiff*sign,yDiff*sign,agent);
				}
			}
		)
	};


	var gameOfLife = function () {

		var getNeigboursNo = function(agent) {
			var ret = 0,
				diffs = [[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]];
			for (var i = 0; i < diffs.length; i++) {
				ret += (world.getAgent(agent.view.x+diffs[i][0],agent.view.y+diffs[i][1])!=null);
			}
			return ret;
		}

		var tmpGrid = [];



		_.each(world.agents,function(agent) {
			if (agent!= null) {
				var n = getNeigboursNo(agent);
				//colourTmpGrid(tmpGrid,agent);
				if ((n<2) || (n>3)) {
					world.removeAgent(agent);
				}
			}
		});

		//wake awakeneing cells from the tmp grid
	};

	//canvas.setLoop(moveRandomly).start();
	canvas.setLoop(gameOfLife).start();

});

</script>
</head>


<body>

<textarea id = "input"></textarea>
<br/>
<input type="button" value="Process Input" onclick="processInput()"></input>
<br/>

<textarea id = "output"></textarea>

<br/><br/>

<canvas id="myCanvas"  width="500" height="500" >
</canvas>


</body>
</html>
